events { worker_connections 1024; }

http {
  include       /etc/nginx/mime.types;
  default_type  application/octet-stream;

  http2 on;
  server_tokens off;

  # Temel ayarlar
  sendfile on;
  tcp_nopush on;
  tcp_nodelay on;
  keepalive_timeout 65;
  types_hash_max_size 2048;
  client_max_body_size 20m;

  # Gzip
  gzip on;
  gzip_vary on;
  gzip_min_length 1024;
  gzip_types
    text/plain
    text/css
    application/json
    application/javascript
    application/xml+rss
    image/svg+xml;

  # Next.js upstream (Docker servis adı: app)
  upstream nextjs_app { server app:3000; keepalive 64; }

  # 80: ACME + HTTPS redirect
  server {
    listen 80;
    server_name mobilegamehunt.com www.mobilegamehunt.com;

    # Let's Encrypt HTTP-01
    location /.well-known/acme-challenge/ { root /var/www/certbot; }

    # Tüm diğer istekleri HTTPS'e yönlendir
    location / { return 301 https://$host$request_uri; }
  }

    # 443: Redirect www -> non-www (canonical domain)
  server {
    listen 443 ssl http2;
    server_name www.mobilegamehunt.com;

    ssl_certificate           /etc/letsencrypt/live/mobilegamehunt.com/fullchain.pem;
    ssl_certificate_key       /etc/letsencrypt/live/mobilegamehunt.com/privkey.pem;
    ssl_trusted_certificate   /etc/letsencrypt/live/mobilegamehunt.com/chain.pem;

    return 301 https://mobilegamehunt.com$request_uri;
  }


  # 443: PROD
  server {
    listen 443 ssl http2;
    server_name mobilegamehunt.com www.mobilegamehunt.com;

    ssl_certificate           /etc/letsencrypt/live/mobilegamehunt.com/fullchain.pem;
    ssl_certificate_key       /etc/letsencrypt/live/mobilegamehunt.com/privkey.pem;
    ssl_trusted_certificate   /etc/letsencrypt/live/mobilegamehunt.com/chain.pem;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers off;

    # /uploads/** doğrudan NGINX'ten (aynı volume read-only mount)
    location ^~ /uploads/ {
      alias /usr/share/nginx/uploads/;
      access_log off;
      expires 30d;
      add_header Cache-Control "public";
      types {
        image/jpeg      jpg jpeg;
        image/png       png;
        image/gif       gif;
        image/webp      webp;
        image/svg+xml   svg;
      }
    }

    # Next.js statikleri
    location /_next/static/ {
      proxy_pass http://nextjs_app;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      expires 1y;
      add_header Cache-Control "public, immutable";
    }

    # Diğer assetler
    location ~* \.(jpg|jpeg|png|gif|ico|svg|webp|css|js)$ {
      proxy_pass http://nextjs_app;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      expires 30d;
      add_header Cache-Control "public";
    }

    # Health proxy (readiness)
    location /health {
      access_log off;
      proxy_pass http://nextjs_app/api/health;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
    }

    # Uygulama
    location / {
      proxy_pass http://nextjs_app;
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto https;
      proxy_read_timeout 86400;
    }
  }
}